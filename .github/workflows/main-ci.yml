name: Main - Continuous Integration

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  ci:
    name: Continuous Integration
    uses: ./.github/workflows/__shared-ci.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  docs-generate-phpdoc:
    runs-on: ubuntu-latest
    needs: ci
    container: phpdoc/phpdoc:3
    env:
      ARTIFACT_PATH: ./_site
    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}
      artifact-path: ${{ env.ARTIFACT_PATH }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ðŸ“ƒ Generate PHP documentation
        run: phpdoc run -d ./src -t $ARTIFACT_PATH/phpdoc

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        id: upload-artifact
        with:
          name: docs-phpdoc
          path: ${{ env.ARTIFACT_PATH }}

  docs-publish:
    name: Publish documentation
    needs: docs-generate-phpdoc
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          artifact-ids: ${{ needs.docs-generate-phpdoc.outputs.artifact-id }}
          path: ${{ needs.docs-generate-phpdoc.outputs.artifact-path }}

      - uses: hoverkraft-tech/ci-github-publish/actions/deploy/jekyll@84e8ace407055e7a40ba6670a8c697e1ce2dfafa # 0.20.1
        id: build
        with:
          site-path: ${{ needs.docs-generate-phpdoc.outputs.artifact-path }}
          pages: |
            ./docs/*.md

      - uses: hoverkraft-tech/ci-github-publish/actions/deploy/github-pages@84e8ace407055e7a40ba6670a8c697e1ce2dfafa # 0.20.1
        id: deployment
        with:
          build-path: ${{ steps.build.outputs.build-path }}
